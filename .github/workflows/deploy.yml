name: deploy

on:
  push:
    branches:
      - master
  # ä¸€å¿œå‹•ç¢ºã®ãŸã‚ã«æ‰‹å‹•ã§ GitHub Actions ã‚’å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹
  # ãã®éš›ã®å¼•æ•°ã¨ã—ã¦ checkout æ™‚ã® ref ã‚’æ¸¡ã—ã¦ã„ã‚‹
  # default éƒ¨åˆ†ã¯ãƒªãƒã‚¸ãƒˆãƒªã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’æŒ‡å®šã™ã‚‹
  workflow_dispatch:
    inputs:
      ref:
        description: branch|tag|SHA to checkout
        default: 'master'
        required: true
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.inputs.ref }}
      - uses: actions/setup-node@v2
        with:
          node-version: '15'
      # æŠ•ç¨¿å†…å®¹ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã« npm run build:posts ã‚’èµ°ã‚‰ã›ã‚‹
      - name: Recreate all posts
        shell: bash
        run: |
          npm install
          npm run build
      - uses: amondnet/vercel-action@v20
        with:
          # GitHub Actions ã® Secrets ã§ä½œæˆã—ãŸå€¤ã‚’å‚ç…§ã™ã‚‹å½¢ã§
          # Vercel ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å¿…è¦ã¨ãªã‚‹å„ç¨®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹
          vercel-token: ${{ secrets.VERCEL_TOKEN }}     # Required
          vercel-args: '--prod'                         # Optional
          vercel-org-id: ${{ secrets.ORG_ID}}           # Required
          vercel-project-id: ${{ secrets.PROJECT_ID}}   # Required
          working-directory: ./
      - name: Slack Notification on Success
        if: success()
        uses: tokorom/action-slack-incoming-webhook@main
        env:
          INCOMING_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          text: Deploy SuccessğŸ‰
          attachments: |
            [
              {
                "color": "good",
                "author_name": "${{ github.actor }}",
                "author_icon": "${{ github.event.sender.avatar_url }}",
                "fields": [
                  {
                    "title": "App Url",
                    "value": "https://nextjs-ts-lp-template.vercel.app/"
                  },
                  {
                    "title": "Commit Message",
                    "value": "${{ env.COMMIT_MESSAGE }}"
                  },
                  {
                    "title": "GitHub Actions URL",
                    "value": "${{ github.event.repository.url }}/actions/runs/${{ github.run_id }}"
                  },
                  {
                    "title": "Compare URL",
                    "value": "${{ github.event.compare }}"
                  }
                ]
              }
            ]
      - name: Slack Notification on Failure
        if: failure()
        uses: tokorom/action-slack-incoming-webhook@main
        env:
          INCOMING_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          text: 'Deploy FailureğŸ¤®'
          attachments: |
            [
              {
                "color": "danger",
                "author_name": "${{ github.actor }}",
                "author_icon": "${{ github.event.sender.avatar_url }}",
                "fields": [
                  {
                    "title": "Commit Message",
                    "value": "${{ env.COMMIT_MESSAGE }}"
                  },
                  {
                    "title": "GitHub Actions URL",
                    "value": "${{ github.event.repository.url }}/actions/runs/${{ github.run_id }}"
                  },
                  {
                    "title": "Compare URL",
                    "value": "${{ github.event.compare }}"
                  }
                ]
              }
            ]

